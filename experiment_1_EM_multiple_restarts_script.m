% *************************************************************************
% Script to load all control patients' data for experiment 1, and run EM
% with multiple restarts to find parameters
% *************************************************************************

file_folder = 'C:\Users\Sam\OneDrive\C-PLACID\Eye Tracking Data\';
file_names = {'armgr.asc'; 'biged.asc'; 'briel.asc'; 'conma.asc';...
    'frani.asc'; 'golsh.asc'; 'grejo.asc'; 'holtr.asc'; 'lewwi.asc';...
    'manjo.asc'; 'mckro.asc'; 'medca.asc'; 'newal.asc'; 'pagjo.asc';...
    'pleri.asc'; 'redjo.asc'; 'strmi.asc'; 'staro.asc'; 'stegr.asc';...
    'towsu.asc'};
n_people = length(file_names);
[eye_tracking_data, target_data] = loadManyFiles(file_folder, file_names);
l_dirs = [[0; 1], [1; 1]./sqrt(2), [1; 0], [1; -1]./sqrt(2), [0; -1],...
    [-1; -1]./sqrt(2), [-1; 0], [-1; 1]./sqrt(2)];
orth_l_dirs = [l_dirs(:, 3:end), l_dirs(:, 1:2)];
fprintf('Transforming data for HMM...\n')
[y, zero_prob, u] =...
    hmmDataManyPeople(eye_tracking_data, target_data, l_dirs, orth_l_dirs);
epsilon = 0.001;
fprintf('Calculating conditional densities p(u | x)...\n')
p_ugx = condProbUX_ManyPeople(u, l_dirs, epsilon);
fprintf('Obtaining data for experiment 1 only...\n')
y_exp1 = arrayfun(@(person_idx) y{person_idx}{1}, (1:n_people)',...
    'UniformOutput', false);
zero_prob_exp1 = arrayfun(@(person_idx) zero_prob{person_idx}{1},...
    (1:n_people)', 'UniformOutput', false);
p_ugx_exp1 = arrayfun(@(person_idx) p_ugx{person_idx}{1}, (1:n_people)',...
    'UniformOutput', false);
n_iters = 500;
epsilon = 1e-5;
n_restarts = 10;
min_eig = 0.01;
not_conma_or_stegr = [1:3, 5:18, 20];
n_training_people = 12;
training_people =...
    not_conma_or_stegr(randperm(length(not_conma_or_stegr), n_training_people));
fprintf('Running EM procedure with %d restarts...\n', n_restarts)
tic; [pi_1_hat, P_hat, emission_means_hat, emission_covs_hat] =...
    EM_ManyPeopleMultipleRestarts(y_exp1(training_people),...
    p_ugx_exp1(training_people), zero_prob_exp1(training_people),...
    n_iters, epsilon, n_restarts, min_eig); toc